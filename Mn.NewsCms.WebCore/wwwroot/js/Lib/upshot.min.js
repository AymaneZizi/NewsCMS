(function(y,e){function f(c,a){for(var b in a)c[b]=a[b]}function h(e){for(var d=e.split("."),a=y,c=0;c<d.length;c++){var b=a[d[c]];if(!b||typeof b!=="object")a[d[c]]=b={};a=b}return a}function p(a,b,c){a=a||function(){};b&&f(a.prototype,b);c&&f(a,c);return a}function r(d,a,c){var b={};f(b,d);f(b,c);a=a||function(){};a.prototype=b;a.prototype.constructor=a;return a}function b(a){return a===null?"null":a===e?"undefined":Object.prototype.toString.call(a).slice(8,-1).toLowerCase()}function w(a){return b(a)==="array"}function v(a){return b(a)==="object"}function z(a){return b(a)==="date"}function s(a){return b(a)==="function"}function A(a){return typeof a==="string"&&/[a-fA-F\d]{8}-(?:[a-fA-F\d]{4}-){3}[a-fA-F\d]{12}/.test(a)}var m=Object.prototype.hasOwnProperty;function x(a){if(a===null||a===e)return true;for(var b in a)if(m.call(a,b))return false;return true}var u=0;function i(a){a||(a="");return a+u++}function B(b,d,f){if(!b)return;if(arguments.length===2){var c=a.cacheName;return c&&b[c]?b[c][d]:null}else{if(b.nodeType!==e)throw"upshot.cache cannot be used with DOM elements";var c=a.cacheName||(a.cacheName=i("__upshot__"));b[c]||(b[c]=function(){});return b[c][d]=f}}function q(c,d){var b=a.cacheName;if(b&&c&&c[b]){if(d)delete c[b][d];if(!d||x(c[b]))delete c[b]}}function l(b,c){if(b.length!==c.length)return false;else for(var a=0;a<b.length;a++)if(b[a]!==c[a])return false;return true}function n(c,d){for(var f=a.isFunction(d)?d:e,b=0;b<c.length;b++)if(f?f(c[b]):c[b]===d){c.splice(b,1);return b}return-1}var a=h("upshot");a.defineNamespace=h;a.defineClass=p;a.deriveClass=r;a.classof=b;a.isArray=w;a.isObject=v;a.isDate=z;a.isFunction=s;a.isGuid=A;a.uniqueId=i;a.cacheName=null;a.cache=B;a.deleteCache=q;a.sameArrayContents=l;a.arrayRemove=n;a.EntityState={Unmodified:"Unmodified",ClientUpdated:"ClientUpdated",ClientAdded:"ClientAdded",ClientDeleted:"ClientDeleted",ServerUpdating:"ServerUpdating",ServerAdding:"ServerAdding",ServerDeleting:"ServerDeleting",Deleted:"Deleted",isClientModified:function(a){return a&&a.indexOf("Client")===0},isServerSyncing:function(a){return a&&a.indexOf("Server")===0}};var d=[];function k(a){d.push(a)}function j(a){d.splice($.inArray(a,d),1)}var c;function g(){if(c)throw"Cannot make observable edits from within an event callback.";try{c=true;var a=d.slice();$.each(a,function(b,a){a.__recomputeDependentViews()});$.each(a,function(b,a){a.__flushEntityStateChangedEvents&&a.__flushEntityStateChangedEvents()})}finally{c=false}}function o(){if(c)throw"Cannot make observable edits from within an event callback.";}function t(){g()}a.__registerRootEntitySource=k;a.__deregisterRootEntitySource=j;a.__triggerRecompute=g;a.__beginChange=o;a.__endChange=t})(this);(function(e,c,b){var a=b.observability=b.observability||{};c.each(["track","insert","remove","refresh","isProperty","getProperty","setProperty","isArray","createCollection","asArray","map","unmap","setContextProperty"],function(c,b){a[b]=function(){var c=a.configuration;return c[b].apply(c,arguments)}});b.map=function(d,b,c){return a.configuration.map(d,b,null,c)}})(this,jQuery,upshot);(function(f,c,a){var d=a.observability,b={};a.metadata=function(d){if(arguments.length===0)return c.extend({},b);else if(typeof d==="string"){if(arguments.length===1)return b[d];else if(!b[d])b[d]=arguments[1]}else c.each(d,function(b,c){a.metadata(b,c)})};a.metadata.getProperties=function(g,h,i){var e=[];if(h){var f=a.metadata(h);if(f&&f.fields){var c=f.fields;for(var b in c)(i||!c[b].association)&&e.push({name:b,type:c[b].type,association:c[b].association});return e}}for(var b in g)g.hasOwnProperty(b)&&d.isProperty(g,b)&&b.indexOf("jQuery")!==0&&e.push({name:b});return e};a.metadata.getPropertyType=function(c,d){if(c){var b=a.metadata(c);if(b&&b.fields&&b.fields[d])return b.fields[d].type}return null}})(this,jQuery,upshot);(function(h,c,a){var b=a.observability,f=function(d){var c=d&&d.result;if(c)if(a.EntitySource.as(c))throw"Array is already bound to an EntitySource.";this._viewsToRecompute=[];this._eventCallbacks={};this._clientEntities=c||b.createCollection();var e=this;b.track(this._clientEntities,{afterChange:function(d,c,b){a.__beginChange();e._handleArrayChange(c,b)},afterEvent:function(){a.__endChange()}});a.cache(this._clientEntities,"entitySource",this)},d={dispose:function(){if(this._eventCallbacks){b.track(this._clientEntities,null);a.deleteCache(this._clientEntities,"entitySource");this._dispose();this._eventCallbacks=null}},bind:function(a,c){if(typeof a==="string"){var d=this._eventCallbacks[a]||(this._eventCallbacks[a]=[]);d.push(c)}else for(var b in a)this.bind(b,a[b]);return this},unbind:function(a,e){if(typeof a==="string"){var b=this._eventCallbacks&&this._eventCallbacks[a];if(b)for(var c=0,f=b.length;c<f;c++)if(b[c]===e){b.splice(c,1);break}}else for(var d in a)this.unbind(d,a[d]);return this},getEntities:function(){return this._clientEntities},__registerForRecompute:function(a){c.inArray(a,this._viewsToRecompute)<=0&&this._viewsToRecompute.push(a)},__recomputeDependentViews:function(){while(this._viewsToRecompute.length>0){var a=this._viewsToRecompute.slice();this._viewsToRecompute.splice(0,this._viewsToRecompute.length);c.each(a,function(b,a){a.__recompute()})}},__addEntity:function(a){var c=b.asArray(this._clientEntities).length;b.insert(this._clientEntities,c,[a]);this._handleArrayChange("insert",{index:c,items:[a]})},__deleteEntity:function(a,d){var d=c.inArray(a,b.asArray(this._clientEntities));b.remove(this._clientEntities,d,1);this._handleArrayChange("remove",{index:d,items:[a]})},_dispose:function(){},_handleArrayChange:function(d,c){switch(d){case"insert":var e=c.items;if(e.length>1)throw"NYI -- Can only add a single entity to/from an array in one operation.";var f=e[0];this._handleEntityAdd(f);break;case"remove":throw"Use 'deleteEntity' to delete entities from your array.  Destructive delete is not yet implemented.";case"replaceAll":if(!a.sameArrayContents(c.newItems,b.asArray(this._clientEntities)))throw"NYI -- Can only replaceAll with own entities.";break;default:throw"NYI -- Array operation '"+d+"' is not supported.";}this._trigger("arrayChanged",d,c)},_handleEntityAdd:function(){},_purgeEntity:function(a){var d=c.inArray(a,b.asArray(this._clientEntities));b.remove(this._clientEntities,d,1);this._trigger("arrayChanged","remove",{index:d,items:[a]})},_trigger:function(c){var a=this._eventCallbacks[c];if(a){var d=Array.prototype.slice.call(arguments,1);a=a.slice(0);for(var b=0,e=a.length;b<e;b++)a[b].apply(this,d)}return this}},e={as:function(b){return a.cache(b,"entitySource")}};a.EntitySource=a.defineClass(f,d,e)})(this,jQuery,upshot);(function(i,c,a){var b=a.EntitySource.prototype,g=a.observability,f=function(a){this._needRecompute=false;var c=this;this._observer={propertyChanged:function(d,b,a){c._onPropertyChanged(d,b,a)},arrayChanged:function(b,a){c._onArrayChanged(b,a)},entityStateChanged:function(a,d,b){c._onEntityStateChanged(a,d,b)}};this._entitySource=null;var d=a&&a.source;d&&this._bindToEntitySource(d);b.constructor.call(this,a)},d=["getTazehaContext","getEntityState","isPropertyChanged","getEntityValidationRules","getEntityId","revertChange","revertChanges","deleteEntity","getEntityErrors","getEntityError","hasChanges"],e={__registerForRecompute:function(){b.__registerForRecompute.apply(this,arguments);this._entitySource.__registerForRecompute(this)},__recompute:function(){if(this._needRecompute){this._needRecompute=false;this._recompute()}this.__recomputeDependentViews()},_dispose:function(){this._entitySource&&this._entitySource.unbind(this._observer);b._dispose.apply(this,arguments)},_bindToEntitySource:function(a){if(this._entitySource===a)return;var b=this;if(this._entitySource){c.each(d,function(c,a){if(b[a])delete b[a]});this._entitySource.bind(this._observer)}this._entitySource=a;a.getTazehaContext&&c.each(d,function(d,c){if(c!=="getEntityErrors")b[c]=function(){var d=a[c].apply(a,arguments);return c==="deleteEntity"||/revertChange/.test(c)?b:d}});this.getEntityErrors=function(){return c.grep(a.getEntityErrors(),function(a){return b._haveEntity(a.entity)})};a.bind(this._observer)},_setNeedRecompute:function(){this._needRecompute=true;this._entitySource.__registerForRecompute(this)},_recompute:function(){throw"Unreachable";},_handleEntityAdd:function(a){this._entitySource.__addEntity(a);b._handleEntityAdd.apply(this,arguments)},_haveEntity:function(a){return c.inArray(a,g.asArray(this._clientEntities))>=0},_purgeEntity:function(){b._purgeEntity.apply(this,arguments)},_onPropertyChanged:function(a,c,b){this._haveEntity(a)&&this._trigger("propertyChanged",a,c,b)},_onArrayChanged:function(){},_onEntityStateChanged:function(b,c,d){if(this._haveEntity(b)){c===a.EntityState.Deleted&&this._purgeEntity(b);this._trigger("entityStateChanged",b,c,d)}}};a.EntityView=a.deriveClass(b,f,e);a.EntityView.__TazehaContextMethodNames=d})(this,jQuery,upshot);(function(i,c,a){var d=a.EntityView.prototype,b=a.observability,e={paging:"setPaging",sort:"setSort",filter:"setFilter"},g=function(a){if(a&&a.result&&a.result.length!==0)throw'NYI -- Currently, "result" array must be empty to bind to a data source.';this._skip=null;this._take=null;this._includeTotalCount=false;this._lastRefreshTotalEntityCount=0;var b=this;this._options=[];a&&c.each(a,function(a,c){if(e[a])b[e[a]](c);else b._options[a]=c});d.constructor.apply(this,arguments)},f={setSort:function(){throw"Unreachable";},setFilter:function(){throw"Unreachable";},setPaging:function(a){a=a||{};this._skip=a.skip;this._take=a.take;this._includeTotalCount=!!a.includeTotalCount;return this},getTotalEntityCount:function(){return this._lastRefreshTotalEntityCount},refresh:function(){throw"Unreachable";},reset:function(){this._applyNewQueryResult([]);return this},_normalizeFilters:function(b){b=a.isArray(b)?b:[b];for(var f=[],e=0;e<b.length;e++){var d=b[e];if(d){if(!c.isFunction(d))d.operator=d.operator||"==";f.push(d)}}return f},_completeRefresh:function(h,g,f){this._applyNewQueryResult(h,g)&&a.__triggerRecompute();var d=b.asArray(this._clientEntities),e=this._lastRefreshTotalEntityCount;this._trigger("refreshSuccess",d,e);c.isFunction(f)&&f.call(this,d,e)},_failRefresh:function(a,b,d,e){this._trigger("refreshError",a,b,d);c.isFunction(e)&&e.call(this,a,b,d)},_trigger:function(a){d._trigger.apply(this,arguments);this._options[a]&&this._options[a].apply(this,Array.prototype.slice.call(arguments,1))},_applyNewQueryResult:function(c,f){this._lastRefreshTotalEntityCount=f;var d=a.sameArrayContents(b.asArray(this._clientEntities),c);if(!d){var e=b.asArray(this._clientEntities).slice();b.refresh(this._clientEntities,c);this._trigger("arrayChanged","replaceAll",{oldItems:e,newItems:b.asArray(this._clientEntities)});return true}else return false}};a.DataSource=a.deriveClass(d,g,f)})(this,jQuery,upshot);(function(i,b,a,e){var d=a.EntitySource.prototype,c=a.observability,h=function(b,c){this._TazehaContext=b;this._entityType=c;this._callbacks={};this._serverEntities=[];this._entityStates={};this._addedEntities=[];this._errors=[];this._associatedEntitiesViews={};this._tracked={};this._tracker=null;this._deferredEntityStateChangeEvents=[];d.constructor.call(this);a.__registerRootEntitySource(this)},f={dispose:function(){throw"EntitySets should only be disposed by their TazehaContext.";},_bind:function(a,d,b){var c=this._callbacks[a]||(this._callbacks[a]=[]);c.push({obj:d,callback:b});return this},_unbind:function(d,e,c){var a=this._callbacks[d];if(a)for(var b=0,f=a.length;b<f;b++)if(a[b]&&e===a[b].obj&&c===a[b].callback){a.splice(b,1);break}return this},_triggerEvent:function(d,f){var h=this,a=this._callbacks[d],e=Array.prototype.slice.call(arguments,1);if(a)for(var b=0,g=a.length;b<g;b++){var c=a[b];c.obj===f&&c.callback.apply(this,e)}return this},getEntityState:function(b){var a=this.getEntityId(b);return a===null?null:this._entityStates[a]},getEntityId:function(b){var a=this._getAddedEntityFromEntity(b);if(a)return a.clientId;try{return this._getClientEntityIdentity(b)}catch(c){return null}},getTazehaContext:function(){return this._TazehaContext},getEntityValidationRules:function(){var b=a.metadata(this._entityType);return b&&b.rules&&{rules:b.rules,messages:b.messages}},isPropertyChanged:function(b,a){return this.hasChanges(b,a)},getEntityErrors:function(){var a=this;return b.map(this._errors,function(c){var b=a._tracked[c];return{entity:b.obj,error:b.error}})},getEntityError:function(b){var a=this._getTrackingId(b);if(a)return this._tracked[a].error},revertChange:function(c,e){var d=this.getEntityId(c),b=d!==null&&this._entityStates[d];if(!b||b===a.EntityState.Deleted)throw"Entity no longer cached in data context.";if(!e)if(b===a.EntityState.ClientDeleted||b===a.EntityState.ClientUpdated){this._updateEntityState(d,a.EntityState.Unmodified);this._restoreOriginalValues(c,this._entityType,null)}else if(b===a.EntityState.ClientAdded)this._purgeUncommittedAddedEntity(this._getAddedEntityFromId(d),true);else throw"Entity changes cannot be reverted for entity in state '"+b+"'.";else if(b!==a.EntityState.ClientUpdated)throw"Property change cannot be reverted for entity in state '"+b+"'.";else{this._changeEntityStateForUpdate(c);this._restoreOriginalValues(c,this._entityType,e)}a.__triggerRecompute();return this},revertChanges:function(b){if(!!b)this._TazehaContext.revertChanges();else{this.__revertChanges();a.__triggerRecompute()}return this},hasChanges:function(d,b){if(a.isArray(d)&&b)throw"Property is not a supported parameter when inspecting array changes";var c=this._getChanges(d);return!c?false:!b?true:c.original.hasOwnProperty(b)},deleteEntity:function(g){var b=this.getEntityId(g),d=b!==null&&this._getEntityIndexFromId(b),c=b!==null&&this._getAddedEntityFromId(b),e=d<0&&c;if(e){var f=this._entityStates[b];if(f===a.EntityState.ClientAdded)this._purgeUncommittedAddedEntity(c,true);else throw"NYI -- Can't edit a entity while previous edits are being committed.";}else if(d<0)throw"Entity no longer cached in data context.";else{if(a.EntityState.isServerSyncing(this._entityStates[b]))throw"NYI -- Can't edit a entity while previous edits are being committed.";this._updateEntityState(b,a.EntityState.ClientDeleted);this._TazehaContext.__queueImplicitCommit()}a.__triggerRecompute();return this},__dispose:function(){var c=this;b.each(this._tracked,function(b,a){c._deleteTracking(a.obj)});a.__deregisterRootEntitySource(this);d.dispose.call(this)},__hasUncommittedEdits:function(){var c=false;b.each(this._entityStates,function(d,b){if(b!==a.EntityState.Unmodified)c=true});return c},__loadEntities:function(f){var g=this,a=[],d=this._serverEntities.length,e=b.map(f,function(b){return g._loadEntity(b,a)});if(a.length>0){c.insert(this._clientEntities,d,a);this._trigger("arrayChanged","insert",{index:d,items:a})}return e},__getEditedEntities:function(){var d=this,c=[];b.each(this._entityStates,function(e,b){a.EntityState.isClientModified(b)&&c.push(d._getEntityFromId(e))});return c},__getEntityEdit:function(c){var f=this.getEntityId(c),e=this,g,d,h=function(a){return b.extend({__type:e._entityType},a)};switch(this._entityStates[f]){case a.EntityState.ClientUpdated:g=a.EntityState.ServerUpdating;d={Operation:3,Entity:h(this._getSerializableEntity(c)),OriginalEntity:h(this._getOriginalValue(c,this._entityType))};break;case a.EntityState.ClientAdded:g=a.EntityState.ServerAdding;c=this._getAddedEntityFromId(f).entity;d={Operation:2,Entity:h(this._getSerializableEntity(c))};break;case a.EntityState.ClientDeleted:g=a.EntityState.ServerDeleting;d={Operation:4,Entity:h(this._getOriginalValue(c,this._entityType))};break;default:throw"Unrecognized entity state.";}var i=e.getEntityError(c),j={entityType:this._entityType,storeEntity:c,operation:d,updateEntityState:function(){e._updateEntityState(f,g,i)},succeeded:function(a){e._handleSubmitSucceeded(f,d,a)},failed:function(a){e._handleSubmitFailed(f,d,a||i)}};return j},__revertChanges:function(){var e;b.each(this._entityStates,function(c,b){if(a.EntityState.isServerSyncing(b)){e=true;return false}});if(e)throw"Can't revert changes while a commit is in progress.";var f=this,c=b.grep(this._addedEntities,function(a){return a.entity&&f._getEntityIndex(a.entity)<0});if(c.length>0){this._addedEntities=b.grep(this._addedEntities,function(a){return b.inArray(a,c)<0});b.each(c,function(b,a){f._purgeUncommittedAddedEntity(a,true)})}for(var d in this._entityStates)if(a.EntityState.isClientModified(this._entityStates[d])){this._updateEntityState(d,a.EntityState.Unmodified);var g=this._getEntityFromId(d);this._restoreOriginalValues(g,this._entityType,null)}},__flushEntityStateChangedEvents:function(){var a=this;b.each(this._deferredEntityStateChangeEvents,function(c,b){a._trigger.apply(a,["entityStateChanged"].concat(b))});this._deferredEntityStateChangeEvents.splice(0,this._deferredEntityStateChangeEvents.length)},__setProperty:function(e,b,f){var d={oldValues:{},newValues:{}};d.oldValues[b]=c.getProperty(e,b);d.newValues[b]=f;this._copyOnWrite(e,d);this._removeTracking(this._getOldFromEvent("change",d));c.setProperty(e,b,f);this._addTracking([f],a.metadata.getPropertyType(this._entityType,b),e,b);this._bubbleChange(e,null,d)},_loadEntity:function(b,f){var d=this._getEntityIdentity(b),e=this._getEntityIndexFromIdentity(d);if(e>=0)b=this._merge(this._serverEntities[e].entity,b);else{var c=d;this._addTracking([b],this._entityType);this._entityStates[c]=a.EntityState.Unmodified;this._serverEntities.push({entity:b,identity:c});this._updateEntityState(c,a.EntityState.Unmodified,null,b);this._addAssociationProperties(b);f.push(b)}return b},_handleEntityAdd:function(b){if(this._getEntityIndex(b)>=0||this._getAddedEntityFromEntity(b))throw"Entity already in data source.";var c=a.uniqueId("added");addedEntity={entity:b,clientId:c};this._addedEntities.push(addedEntity);this._addTracking([b],this._entityType);this._entityStates[c]=a.EntityState.Unmodified;this._updateEntityState(c,a.EntityState.ClientAdded);this._addAssociationProperties(b);this._TazehaContext.__queueImplicitCommit();d._handleEntityAdd.apply(this,arguments)},_changeEntityStateForUpdate:function(b){var c=this._getEntityIndex(b),e=c<0&&this._getAddedEntityFromEntity(b);if(e){var f=this._entityStates[this.getEntityId(b)];if(f!==a.EntityState.ClientAdded)throw"NYI -- Can't update an added entity while it's being committed.";}else if(c<0)throw"Entity no longer cached in data context.";else{var d=this.getEntityId(b);if(a.EntityState.isServerSyncing(this._entityStates[d]))throw"NYI -- Can't edit a entity while previous edits are being committed.";this._updateEntityState(d,a.EntityState.ClientUpdated,this.getEntityError(b))}this._TazehaContext.__queueImplicitCommit()},_updateEntityState:function(d,b,f,a){a=a||this._getEntityFromId(d);var e=this._entityStates[d];if(this._entityStates[d]){this._entityStates[d]=b;e!==b&&c.setContextProperty(a,"EntityState",b)}var g=this._updateEntityError(a,f);(e!==b||g)&&this._deferredEntityStateChangeEvents.push([a,b,f])},_updateEntityError:function(h,a){var f=this._getTrackingId(h),e=this._tracked[f],d,g=b.inArray(f,this._errors);if(g<=-1){if(a){this._errors.push(f);e.error=a;d=true}}else if(a){if(a!==e.error){e.error=a;d=true}}else{this._errors.splice(g,1);delete e.error;d=true}d&&c.setContextProperty(h,"EntityError",a);return d},_purgeEntityAtIndex:function(d){var c=this._serverEntities[d].entity,a=this.getEntityId(c);this._removeTracking([c]);this._serverEntities.splice(d,1);this._purgeEntity(c);delete this._entityStates[a];this._disposeAssociationEntitiesViews(a);if(this._getAddedEntityFromId(a))this._addedEntities=b.grep(this._addedEntities,function(b){return b.clientId!==a})},_getEntityIdentity:function(b){return a.EntitySet.__getIdentity(b,this._entityType)},_getEntityIndexFromId:function(f){var b=this._getAddedEntityFromId(f),c;if(!b)c=f;else if(b.serverId===e)return-1;else c=b.serverId;for(var d=-1,a=0;a<this._serverEntities.length;a++)if(this._serverEntities[a].identity===c){d=a;break}return d},_getEntityIndexFromIdentity:function(c){for(var b=-1,a=0;a<this._serverEntities.length;a++)if(this._serverEntities[a].identity===c){b=a;break}return b},_getEntityIndex:function(c){for(var b=-1,a=0;a<this._serverEntities.length;a++)if(this._serverEntities[a].entity===c){b=a;break}return b},_getClientEntityIdentity:function(a){return this._getEntityIdentity(this.hasChanges(a)?this._getOriginalValue(a,this._entityType):a)},_addTracking:function(c,f,d,a){var e=this;b.each(c,function(c,b){e._addTrackingRecursive(d,a,b,f)})},_addTrackingRecursive:function(g,j,d,f){if(a.isArray(d)||a.isObject(d)){var e=this._getTracking(d);if(e){if(e.active)throw"Value is already tracked";}else{var i=a.cache(d,"trackingId",a.uniqueId("tracking"));e=this._tracked[i]={}}e.obj=d;e.type=f;e.parentId=this._getTrackingId(g)||null;e.property=a.isArray(g)?null:j;e.active=true;e.changes=e.changes||null;c.track(d,this._getTracker(),this._entityType);if(a.isArray(d)){if(d.length>0&&(a.isArray(d[0])||a.isObject(d[0]))){var h=this;b.each(d,function(a,b){h._addTrackingRecursive(d,a,b,f)})}}else{var h=this;b.each(a.metadata.getProperties(d,f),function(b,a){h._addTrackingRecursive(d,a.name,c.getProperty(d,a.name),a.type)})}}},_getTracker:function(){if(this._tracker===null){var c=this;this._tracker={beforeChange:function(b,d,a){if(!c._isAssociationPropertySet(b,d,a)){c._copyOnWrite(b,a);c._removeTracking(c._getOldFromEvent(d,a))}},afterChange:function(d,f,e){a.__beginChange();if(!c._handleAssociationPropertySet(d,f,e)){var g=c._getTracking(d);if(f==="change")b.each(e.newValues,function(b,e){c._addTracking([e],a.metadata.getPropertyType(g.type,b),d,b)});else c._addTracking(c._getNewFromEvent(f,e),g.type,d);c._bubbleChange(d,null,e)}},afterEvent:function(){a.__endChange()}};if(this._TazehaContext.__manageAssociations)this._tracker.includeAssociations=true}return this._tracker},_isAssociationPropertySet:function(g,e,b){if(e==="change"&&this._TazehaContext.__manageAssociations&&this._getTracking(g).parentId===null){var c=(a.metadata(this._entityType)||{}).fields;if(c)for(var d in c){var f=c[d];if(f.association&&(d in b.oldValues||d in b.newValues)){if(this._getOldFromEvent(e,b).length>1||this._getNewFromEvent(e,b).length>1)throw"NYI -- Can't include association properties in N>1 property sets.";return true}}}return false},_handleAssociationPropertySet:function(e,h,b){if(!this._isAssociationPropertySet(e,h,b))return false;var c=this.getEntityId(e);if(c===null||!(c in this._entityStates))throw"Entity no longer cached in data context.";var a;for(var d in b.oldValues){a=d;break}if(!a)for(var d in b.newValues){a=d;break}var f=this._associatedEntitiesViews[c],g=f[a];g.__handleParentPropertySet(b.newValues[a]);return true},_removeTracking:function(a){var c=this;b.each(a,function(b,a){c._removeTrackingRecursive(a)})},_removeTrackingRecursive:function(d){if(a.isArray(d)||a.isObject(d)){var e=this._getTracking(d);if(e){if(e.changes===null)this._deleteTracking(d);else e.active=false;c.track(d,null);if(a.isArray(d)){if(d.length>0&&(a.isArray(d[0])||a.isObject(d[0]))){var f=this;b.each(d,function(b,a){f._removeTrackingRecursive(a)})}}else{var f=this;b.each(d,function(a){f._removeTrackingRecursive(c.getProperty(d,a))})}}}},_deleteTracking:function(b){var c=this._getTrackingId(b);a.deleteCache(b,"trackingId");delete this._tracked[c]},_getOldFromEvent:function(c,a){if(c==="change"){var d=[];b.each(a.oldValues,function(b,a){d.push(a)});return d}else if(c==="remove")return a.items;else if(c==="replaceAll")return a.oldItems;return[]},_getNewFromEvent:function(c,a){if(c==="change"){var d=[];b.each(a.newValues,function(b,a){d.push(a)});return d}else if(c==="insert")return a.items;else if(c==="replaceAll")return a.newItems;return[]},_getTrackingId:function(b){return a.cache(b,"trackingId")},_getTracking:function(b){var a=this._getTrackingId(b);return a?this._tracked[a]:null},_getChanges:function(a){var b=this._getTracking(a);return b?this._getTracking(a).changes:null},_bubbleChange:function(b,c,d){var e=this._getTracking(b).parentId;c&&this._recordChangedChild(b,c);if(e===null)if(a.isArray(b))this._handleArrayChangeInternal(b);else this._handlePropertyChangeInternal(b,d,c===null);else this._bubbleChange(this._tracked[e].obj,b,d);this._triggerEvent("change",b,true)},_copyOnWrite:function(b,c){if(a.isArray(b))this._recordWriteToArray(b);else this._recordWriteToObject(b,c.oldValues)},_recordWriteToArray:function(c){var a=this._getTracking(c),b=a.changes||(a.changes={original:null,children:{}});b.original||(b.original=c.slice(0))},_recordWriteToObject:function(e,d){var a=this._getTracking(e),c=a.changes||(a.changes={original:{},children:{}});b.each(d,function(a,b){c.original.hasOwnProperty(a)||(c.original[a]=b)})},_recordChangedChild:function(b,c){a.isArray(b)?this._recordChangedChildOfArray(b,c):this._recordChangedChildOfObject(b,c)},_recordChangedChildOfArray:function(d,e){var a=this._getTracking(d),c=a.changes||(a.changes={original:null,children:{}}),b=this._getTrackingId(e);c.children[b]=b},_recordChangedChildOfObject:function(e,d){var a=this._getTracking(e),c=a.changes||(a.changes={original:{},children:{}}),b=this._getTrackingId(d);c.children[b]=b},_clearChanges:function(c){var a=this._getTracking(c),d=a.changes;if(d){a.changes=null;!a.active&&this._deleteTracking(c);this._triggerEvent("change",c,false);var e=this;b.each(d.children,function(b,a){e._clearChanges(e._tracked[a].obj)})}},_getOriginalValue:function(d,h,g){if(a.isArray(d)&&g)throw"property is not a supported parameter when getting original array values";var i=this,e=this._getChanges(d),f;if(g)return this._getOriginalValue(e&&e.original.hasOwnProperty(g)?e.original[g]:c.getProperty(d,g),a.metadata.getPropertyType(h,g));else if(a.isArray(d)){f=(e?e.original||d:d).slice(0);b.each(f,function(a,b){f[a]=i._getOriginalValue(b,h)});return f}else if(a.isObject(d)){f={};b.each(a.metadata.getProperties(d,h),function(g,a){var b=e&&e.original&&e.original.hasOwnProperty(a.name)?e.original[a.name]:c.getProperty(d,a.name);f[a.name]=i._getOriginalValue(b,a.type)});return f}return d},_restoreOriginalValues:function(e,g,d){if(a.isArray(e)&&d)throw"property is not a supported parameter when restoring array values";var c=this._getChanges(e);if(c){var f=this;if(d){if(c.original.hasOwnProperty(d)){var i=c.original[d];delete c.original[d];this._setProperty(e,g,d,i)}b.each(c.children,function(c,b){var a=f._tracked[b];a.property===d&&f._restoreOriginalValues(a.obj,a.type,null)})}else{if(a.isArray(e))c.original!==null&&f._arrayRefresh(e,g,c.original);else{var h=[];b.each(c.original,function(a){h.push(a)});b.each(h,function(d,a){var b=c.original[a];delete c.original[a];f._setProperty(e,g,a,b)})}b.each(c.children,function(c,b){var a=f._tracked[b];f._restoreOriginalValues(a.obj,a.type,null)});this._clearChanges(e)}}},_merge:function(a,b){!this.hasChanges(a)&&this._mergeObject(a,b,this._entityType);return a},_mergeObject:function(g,f,e){var d=this;b.each(a.metadata.getProperties(f,e,false),function(j,i){var b=c.getProperty(g,i.name),h=c.getProperty(f,i.name);if(b!==h){if(a.classof(b)===a.classof(h))if(a.isArray(b)&&(b.length>0?a.isObject(b[0]):a.isObject(h[0]))){d._mergeArray(b,h,i.type);return}else if(a.isObject(b)){d._mergeObject(b,h,i.type);return}d._setProperty(g,e,i.name,h)}})},_mergeArray:function(a,c,d){var e=this;b.each(c,function(c,f){var b=a[c];b&&e._mergeObject(b,f,d)});if(a.length>c.length)this._arrayRemove(a,d,c.length,a.length-c.length);else a.length<c.length&&this._arrayInsert(a,d,a.length,c.slice(a.length))},_handlePropertyChangeInternal:function(d,b,f){var a,e;for(var c in b.newValues)if(b.newValues.hasOwnProperty(c)){if(a)throw"NYI -- Can only update one property at a time.";a=c;e=b.newValues[c]}if(a==="")return;f&&this._trigger("propertyChanged",d,a,e);this._changeEntityStateForUpdate(d)},_handleArrayChangeInternal:function(a){this._changeEntityStateForUpdate(a)},_setProperty:function(b,g,d,e){var f=this._getTracking(b).parentId;this._removeTracking([c.getProperty(b,d)]);c.setProperty(b,d,e);this._addTracking([e],a.metadata.getPropertyType(g,d),b,d);f===null&&this._trigger("propertyChanged",b,d,e);this._triggerEvent("change",b,true)},_arrayRefresh:function(a,d,b){this._removeTracking(a);c.refresh(a,b);this._addTracking(a,d,a)},_arrayRemove:function(b,e,d,a){this._removeTracking(b.slice(d,a));c.remove(b,d,a)},_arrayInsert:function(a,e,d,b){c.insert(a,d,b);this._addTracking(b,e,a)},_getAddedEntityFromId:function(c){var a=b.grep(this._addedEntities,function(a){return a.clientId===c});return a[0]},_getAddedEntityFromEntity:function(c){var a=b.grep(this._addedEntities,function(a){return a.entity===c});return a[0]},_handleSubmitSucceeded:function(b,h,e){var d=this._getEntityFromId(b);switch(h.Operation){case 2:this._updateEntityState(b,a.EntityState.Unmodified);var c=this._getAddedEntityFromId(b),f=this._getEntityIdentity(e.Entity);c.serverId=f;this._serverEntities.push({entity:c.entity,identity:f});this._clearChanges(c.entity);this._merge(c.entity,e.Entity);break;case 3:this._updateEntityState(b,a.EntityState.Unmodified);this._clearChanges(d);this._merge(d,e.Entity);break;case 4:this._updateEntityState(b,a.EntityState.Deleted,null,d);var g=this._getEntityIndexFromId(b);this._purgeEntityAtIndex(g,true)}},_handleSubmitFailed:function(c,d,e){var f=this._getEntityFromId(c),b;switch(d.Operation){case 2:b=a.EntityState.ClientAdded;break;case 3:b=a.EntityState.ClientUpdated;break;case 4:b=a.EntityState.ClientDeleted}this._updateEntityState(c,b,e)},_purgeUncommittedAddedEntity:function(c){var e=c.clientId,d=c.entity;this._updateEntityState(e,a.EntityState.Deleted,null,d);this._removeTracking([d]);this._addedEntities=b.grep(this._addedEntities,function(a){return a!==c});delete this._entityStates[e];this._disposeAssociationEntitiesViews(e);this._purgeEntity(d)},_getEntityFromId:function(d){var a=this._getAddedEntityFromId(d),c;if(!a)c=d;else if(a.serverId===e)return a.entity;else c=a.serverId;for(var b=0;b<this._serverEntities.length;b++)if(this._serverEntities[b].identity===c)return this._serverEntities[b].entity},_addAssociationProperties:function(e){if(!this._TazehaContext.__manageAssociations)return;var d=(a.metadata(this._entityType)||{}).fields;if(d){var g=this.getEntityId(e),c=this._associatedEntitiesViews[g]={},f=this;b.each(d,function(a,b){if(b.association){if(c[a])throw"Duplicate property metadata for property '"+a+"'.";c[a]=f._createAssociatedEntitiesView(e,a,b)}})}},_createAssociatedEntitiesView:function(d,e,b){if(!b.association.isForeignKey&&!b.array)throw"NYI: Singleton child entities are not currently supported";var h=this._TazehaContext.getEntitySet(b.type),f=b.association.isForeignKey,i=f?function(){var b=c.getProperty(d,e),a=c.asArray(this.getEntities())[0]||null;if(b!==a){c.setProperty(d,e,a);this._trigger("propertyChanged",d,e,a)}}:null,j=f?h:this,k=f?this:h,g;if(b.array){g=c.createCollection();d[e]=g}return new a.AssociatedEntitiesView(d,j,k,b.association,i,g)},_disposeAssociationEntitiesViews:function(c){var a=this._associatedEntitiesViews[c];a&&b.each(a,function(b,a){a.dispose()});delete this._associatedEntitiesViews[c]},_getSerializableEntity:function(c){if(!this._TazehaContext.__manageAssociations)return c;var d={};b.each(a.metadata.getProperties(c,this._entityType),function(b,a){d[a.name]=c[a.name]});return d}},g={__getIdentity:function(h,d){var i=a.metadata(d);if(!i)throw"No metadata available for type '"+d+"'.  Register metadata using 'upshot.metadata(...)'.";var e=i.key;if(!e)throw"No key metadata specified for entity type '"+d+"'";if(e.length==1&&e[0].indexOf(".")==-1){var g=e[0];a.EntitySet.__validateKeyMember(g,g,h,d);return c.getProperty(h,g).toString()}var f="";b.each(e,function(j,g){if(f.length>0)f+=",";var i=g.split("."),e=h;b.each(i,function(f,b){a.EntitySet.__validateKeyMember(b,g,e,d);e=c.getProperty(e,b)});f+=e});return f},__validateKeyMember:function(c,d,a,b){if(!a||!(c in a))throw"Key member '"+d+"' doesn't exist on entity type '"+b+"'";}};a.EntitySet=a.deriveClass(d,h,f);b.extend(a.EntitySet,g)})(this,jQuery,upshot);(function(h,a,b,f){var c=b.observability,g=function(c,a,d){if(this._trigger===f)return new b.TazehaContext(c,a);this._dataProvider=c;this.__manageAssociations=true;this._implicitCommitHandler=a;this._eventCallbacks={};this._entitySets={};this._mappings={};d&&this.addMapping(d)};function d(e,b){var c;if(b){c=a.extend(c,b[e]||{});for(var d in b)if(d!=="get"&&d!=="submit")c[d]=b[d]}return c}var e={dispose:function(){if(this._entitySets){a.each(this._entitySets,function(b,a){a.__dispose()});this._entitySets=null}},bind:function(a,c){if(typeof a==="string"){var d=this._eventCallbacks[a]||(this._eventCallbacks[a]=[]);d.push(c)}else for(var b in a)this.bind(b,a[b]);return this},unbind:function(a,e){if(typeof a==="string"){var b=this._eventCallbacks[a];if(b)for(var c=0,f=b.length;c<f;c++)if(b[c]===e){b.splice(c,1);break}}else for(var d in a)this.unbind(d,a[d]);return this},addMapping:function(c,b){if(typeof c==="string"){var e=b;b={};b[c]=e}else b=c;var d=this;a.each(b,function(e,b){if(a.isFunction(b))b={map:b};var c=d._mappings[e];if(!c){var f=d._entitySets[e];if(f&&f.getEntities().length>0)throw"Supply a mapping for a type before loading data of that type";d._mappings[e]={map:b.map,unmap:b.unmap}}else if(c.map!==b.map||c.unmap!==b.unmap)throw"For a given type, TazehaContext.addMapping must be supplied the same map/unmap functions.";})},getEntitySet:function(a){var c=this._entitySets[a];if(!c)c=this._entitySets[a]=new b.EntitySet(this,a);return c},getEntityErrors:function(){var b=[];a.each(this._entitySets,function(d,c){var a=[b.length,0].concat(c.getEntityErrors());[].splice.apply(b,a)});return b},getEntityError:function(c){var b;a.each(this._entitySets,function(d,a){b=a.getEntityError(c);return!b});return b},commitChanges:function(a,b,c){if(this._implicitCommitHandler)throw"Data context must be in change-tracking mode to explicitly commit changes.";this._commitChanges(a,b,c);return this},revertChanges:function(){a.each(this._entitySets,function(b,a){a.__revertChanges()});b.__triggerRecompute();return this},merge:function(g,e,d){var h=this;d=d||{};a.each(g,function(b,a){c.setProperty(a,"__type",e);h.__flatten(a,e,d)});a.each(d,function(d,b){a.each(b,function(b,a){c.setProperty(a,"__type",d)});var e=h.getEntitySet(d);e.__loadEntities(b)});var f=e&&this.getEntitySet(e),i=f?f.__loadEntities(g):[];b.__triggerRecompute();return i},__flatten:function(e,f,d){var g=this;a.each(b.metadata.getProperties(e,f,true),function(l,j){var i=c.getProperty(e,j.name);if(i)if(j.association){var k=b.isArray(i)?i:[i],h=j.type,f=d[h]||(d[h]=[]);a.each(k,function(e,a){var c=b.EntitySet.__getIdentity(a,h);if(!f.identityMap)f.identityMap={};if(!f.identityMap[c]){f.identityMap[c]=true;f.push(a);g.__flatten(a,h,d)}})}})},__load:function(e,j,k){a.each(this._entitySets,function(b,a){if(a.__hasUncommittedEdits())throw"Load is not allowed while the data source contains uncommitted edits.";});var g=this._dataProvider,c=this,h=function(d){d.metadata&&b.metadata(d.metadata);var f=d.type||e.entityType;if(!f)throw"Unable to determine entity type.";var i=a.map(d.entities,function(a){return c._mapEntity(a,f)}),g;if(d.includedEntities){g={};a.each(d.includedEntities,function(b,d){g[b]=a.map(d,function(a){return c._mapEntity(a,b)})})}var h=c.merge(i,f,g);j.call(c,c.getEntitySet(f),h,d.totalCount)},i=function(a,b,d){k.call(c,a,b,d)},f=d("get",e.providerParameters);g.get(f,e.queryParameters,h,i)},__queueImplicitCommit:function(){if(this._implicitCommitHandler)if(!this._implicitCommitQueued){this._implicitCommitQueued=true;var a=this;setTimeout(function(){a._implicitCommitQueued=false;a._implicitCommitHandler()},0)}},_trigger:function(c){var a=this._eventCallbacks[c];if(a){var d=Array.prototype.slice.call(arguments,1);a=a.slice(0);for(var b=0,e=a.length;b<e;b++)a[b].apply(this,d)}return this},_submitChanges:function(p,k,h,i){this._trigger("commitStart");var f=a.map(k,function(a){return a.entitySet.__getEntityEdit(a.entity)});a.each(f,function(b,a){a.updateEntityState()});var e=this,g=function(d,c,a){var b={Id:a.Id,Operation:a.Operation};if(a.Operation!==4)b.Entity=e._mapEntity(a.Entity,c);return b},l=function(f,b,a){var d={Id:f.toString(),Operation:a.Operation,Entity:a.Entity,OriginalEntity:a.OriginalEntity};if(a.Operation!==4){var g=(e._mappings[b]||{}).unmap||c.unmap;d.Entity=g(a.Entity,b)}return d},m=a.map(f,function(a,b){return l(b,a.entityType,a.operation)}),n=function(c){a.each(f,function(b,a){a.succeeded(g(a.storeEntity,a.entityType,c[b]))});b.__triggerRecompute();e._trigger("commitSuccess",c);h&&h.call(e,c)},o=function(d,h,j,c){a.each(f,function(d,a){if(c){var b=c[d];if(b.Error)a.failed(b.Error);else a.succeeded(g(a.storeEntity,a.entityType,b))}else a.failed(null)});b.__triggerRecompute();e._trigger("commitError",d,h,j,c);i&&i.call(e,d,h,j,c)},j=d("submit",p.providerParameters);this._dataProvider.submit(j,m,n,o)},_commitChanges:function(d,e,f){var c=[];a.each(this._entitySets,function(e,b){var d=a.map(b.__getEditedEntities(),function(a){return{entitySet:b,entity:a}});[].push.apply(c,d)});this._submitChanges(d,c,e,f);b.__triggerRecompute()},_mapEntity:function(b,a){return this._map(b,a,true)},_map:function(a,d,g){if(g||b.isObject(a)){var e=(this._mappings[d]||{}).map;if(e)return new e(a)}var h=this,f=function(b,a){return h._map(b,a)};return c.map(a,d,f)}};b.TazehaContext=b.defineClass(g,e)})(this,jQuery,upshot);(function(g,a,b){function d(c,e){var a,d;if(e){a=c.Results;d=c.TotalCount}else a=c;return{entities:b.isArray(a)?a:[a],totalCount:d}}var c={"get":function(e,j,f,g){var k,c;if(e){k=e.operationName;c=e.operationParameters}if(a.isFunction(c)){f=c;g=j}var h=this,n=b.DataProvider.normalizeUrl(e.url)+k,i=b.ODataDataProvider.getODataQueryParameters(j),m=a.extend({},c,i),l=i.$inlinecount=="allpages";a.ajax({url:n,data:m,success:f&&function(){arguments[0]=d(arguments[0],l);f.apply(h,arguments)},error:g&&function(a,c,b){g.call(h,a.status,h._parseErrorText(a.responseText)||b,a)},dataType:"json"})},submit:function(h,f,e,c){a.each(f,function(b,a){switch(a.Operation){case 2:a.Operation=1;break;case 3:a.Operation=2;break;case 4:a.Operation=3}});var d=this,g=JSON.stringify(f);a.ajax({url:b.DataProvider.normalizeUrl(h.url)+"Submit",contentType:"application/json",data:g,dataType:"json",type:"POST",success:(e||c)&&function(k,l,j){var b=k,i=false;b&&a.each(b,function(c,b){a.each(["ConflictMembers","ValidationErrors","IsDeleteConflict"],function(c,a){if(b.hasOwnProperty(a)){b.Error=b.Error||{};b.Error[a]=b[a];i=true}})});if(!i)e&&e.call(d,b);else if(c){var h="Submit failed.";if(b)for(var f=0;f<b.length;++f){var g=b[f].ValidationErrors&&b[f].ValidationErrors[0]&&b[f].ValidationErrors[0].Message;if(g){h=g;break}}c.call(d,j.status,h,j,b)}},error:c&&function(a,e,b){c.call(d,a.status,d._parseErrorText(a.responseText)||b,a)}})},_parseErrorText:function(b){var c=/Exception]: (.+)\r/g.exec(b);if(c&&c[1])return c[1];if(/^{.*}$/g.test(b)){var a=JSON.parse(b);if(a.ErrorMessage)return a.ErrorMessage;else if(a.Message)return a.Message}}},e={normalizeUrl:function(a){return a&&a.substring(a.length-1)!=="/"?a+"/":a}};b.DataProvider=b.defineClass(null,c,e)})(this,jQuery,upshot);(function(g,a,b,d){var c=b.DataSource.prototype,f=function(e){if(this._trigger===d)return new b.RemoteDataSource(e);this._sort=null;this._filters=null;var g,h,f;if(e){this._providerParameters=e.providerParameters;this._entityType=e.entityType;h=e.TazehaContext;if(!e.provider&&!e.TazehaContext)g=b.DataProvider;else g=e.provider;if(a.isFunction(g))g=new g;f=e.mapping;if(f&&(a.isFunction(f)||(a.isFunction(f.map)||a.isFunction(f.unmap)))){if(!this._entityType)throw"Need 'entityType' option in order to supply "+(a.isFunction(f)?"a function":"map/unmap functions")+" for 'mapping' option.";var m=f;f={};f[this._entityType]=m}}var i=this;if(!h){var j;if(!e.bufferChanges)j=function(){i._TazehaContext._commitChanges({providerParameters:i._providerParameters})};h=new b.TazehaContext(g,j,f)}else f&&h.addMapping(f);this._TazehaContext=h;var l={};a.each(["commitStart","commitSuccess","commitError"],function(b,a){l[a]=function(){i._trigger.apply(i,[a].concat(Array.prototype.slice.call(arguments)))}});this._TazehaContextObserver=l;this._TazehaContext.bind(this._TazehaContextObserver);var k=e&&e.entityType&&this._TazehaContext.getEntitySet(e.entityType);if(k)e=a.extend({},e,{source:k});else{a.each(b.EntityView.__TazehaContextMethodNames,function(b,a){if(a!=="getTazehaContext")i[a]=function(){throw'TazehaContext-specific methods are not available on RemoteDataSource a result type can be determined.  Consider supplying the "entityType" option when creating a RemoteDataSource or execute an initial query against your RemoteDatasource to determine the result type.';}});this.getTazehaContext=function(){return this._TazehaContext}}c.constructor.call(this,e)},e={setSort:function(a){this._sort=a&&!b.isArray(a)?[a]:a;return this},setFilter:function(a){this._filters=a&&this._normalizeFilters(a);return this},refresh:function(b,c,f){if(a.isFunction(b)){f=c;c=b;b=d}this._trigger("refreshStart");var e=this,g=function(b,d,a){e._bindToEntitySource(b);e._completeRefresh(d,a,c)},h=function(a,b,c){e._failRefresh(a,b,c,f)};this._TazehaContext.__load({entityType:this._entityType,providerParameters:this._providerParameters,queryParameters:{filters:this._filters,sort:this._sort,skip:this._skip,take:this._take,includeTotalCount:this._includeTotalCount}},g,h);return this},commitChanges:function(b,c){this._TazehaContext.commitChanges({providerParameters:this._providerParameters},a.proxy(b,this),a.proxy(c,this));return this},_dispose:function(){this._TazehaContext.unbind(this._TazehaContextObserver);c._dispose.apply(this,arguments)}};b.RemoteDataSource=b.deriveClass(c,f,e)})(this,jQuery,upshot);(function(h,b,d,e){var c=d.EntityView.prototype,a=d.observability,g=function(j,d,e,a,g,k){this._entity=j;this._parentEntitySet=d;this._childEntitySet=e;this._associationMetadata=a;this._parentPropertySetter=g;var f=this;this._sourceEntitySetObserver=function(e,c){!f._needRecompute&&b.inArray(c,a.thisKey)>=0&&f._setNeedRecompute()};var h=a.isForeignKey?e:d;h.bind("propertyChanged",this._sourceEntitySetObserver);var i=a.isForeignKey?d:e;c.constructor.call(this,{source:i,result:k});this._initialized=false;this._setNeedRecompute()},f={__handleParentPropertySet:function(a){this._handleRelationshipEdit(this._entity,a)},_dispose:function(){var a=this._associationMetadata.isForeignKey?this._childEntitySet:this._parentEntitySet;a.unbind("propertyChanged",this._sourceEntitySetObserver);c._dispose.apply(this,arguments)},_handleEntityAdd:function(a){this._handleRelationshipEdit(a,this._entity)},_handleRelationshipEdit:function(h,g){var d=this._associationMetadata,k=d.isForeignKey,f;if(!g)f=null;else{if(b.inArray(g,a.asArray(this._parentEntitySet.getEntities()))<0)throw"Parent entity is not in the parent entity set for this association.";else if((this._parentEntitySet.getEntityState(g)||"").indexOf("Add")>0)throw"NYI -- Cannot set foreign keys to key values computed from added entities.  Commit the parent entity first.";var l=k?d.otherKey:d.thisKey;f=a.getProperty(g,l[0]);if(f===e)throw"Parent entity has no value for its '"+l[0]+"' key property.";}var m=k?d.thisKey:d.otherKey,j=a.getProperty(h,m[0]),i;if(!g){if(j!==null)i=true}else if(j===e||j!==f)i=true;var n=!k;n&&b.inArray(h,a.asArray(this._entitySource.getEntities()))<0&&c._handleEntityAdd.call(this,h);i&&this._childEntitySet.__setProperty(h,m[0],f)},_onPropertyChanged:function(e,a){!this._needRecompute&&b.inArray(a,this._associationMetadata.otherKey)>=0&&this._setNeedRecompute();c._onPropertyChanged.apply(this,arguments)},_onArrayChanged:function(c,d){if(this._needRecompute)return;var a;switch(c){case"insert":case"remove":var e=this;b.each(d.items,function(d,b){if(e._haveEntity(b)^c==="insert"){a=true;return false}});break;case"replaceAll":a=true;break;default:throw"NYI -- Array operation '"+c+"' is not supported.";}a&&this._setNeedRecompute()},_recompute:function(){var c=this._clientEntities,d=this._computeAssociatedEntities();if(!this._initialized){this._initialized=true;if(d.length>0){var h=a.asArray(c).slice();a.refresh(c,d);this._trigger("arrayChanged","replaceAll",{oldItems:h,newItems:a.asArray(c)})}}else{var e=this,g=b.grep(d,function(d){return b.inArray(d,a.asArray(c))<0});b.each(g,function(g,f){var b=a.asArray(c).length,d=[f];a.insert(c,b,d);e._trigger("arrayChanged","insert",{index:b,items:d})});var f=b.grep(a.asArray(c),function(a){return b.inArray(a,d)<0});b.each(f,function(g,f){var d=b.inArray(f,a.asArray(c));a.remove(c,d,1);e._trigger("arrayChanged","remove",{index:d,items:[f]})})}this._parentPropertySetter&&this._parentPropertySetter.apply(this)},_computeAssociatedEntities:function(){for(var l=this._entity,b=this._associationMetadata,j=a.getProperty(l,b.thisKey[0]),i=b.isForeignKey?this._parentEntitySet:this._childEntitySet,f=a.asArray(i.getEntities()),k=b.otherKey,d=[],c=0;c<f.length;c++){var h=f[c],g=a.getProperty(h,k[0]);g!==e&&g===j&&d.push(h)}return d}};d.AssociatedEntitiesView=d.deriveClass(c,g,f)})(this,jQuery,upshot);(function(h,b,a,e){var c=a.DataSource.prototype,d=a.observability,g=function(b){if(this._trigger===e)return new a.LocalDataSource(b);var f=b&&b.source;if(f&&!f.__recomputeDependentViews){var g=d.isArray(f)&&a.EntitySource.as(f);if(!g)throw"Input data for a LocalDataSource must be an EntitySource or the array returned by EntitySource.getEntities().";b.source=g}this._autoRefresh=b&&b.autoRefresh;this._sort=null;this._filter=null;this._refreshAllInProgress=false;c.constructor.call(this,b);this._autoRefresh&&this.refresh()},f={setSort:function(a){this._sort=a;return this},setFilter:function(a){this._filter=a&&this._createFilterFunction(a)},refresh:function(c,f,h){if(b.isFunction(c)){h=f;f=c;c=e}this._trigger("refreshStart");var a=this,i=this._entitySource.refresh;if(c&&!!c.all&&i){this._refreshAllInProgress=true;this._entitySource.refresh({all:true},function(b){g(b);a._refreshAllInProgress=false},function(b,c,d){a._failRefresh(b,c,d,h)})}else setTimeout(function(){g(d.asArray(a._entitySource.getEntities()))});return this;function g(c){a._needRecompute=false;var b=a._applyQuery(c);a._completeRefresh(b.entities,b.totalCount,f)}},refreshNeeded:function(){return this._needRecompute},_setNeedRecompute:function(){if(this._autoRefresh)c._setNeedRecompute.call(this);else{this._needRecompute=true;this._trigger("refreshNeeded")}},_recompute:function(){this._trigger("refreshStart");var a=this._applyQuery(d.asArray(this._entitySource.getEntities()));this._applyNewQueryResult(a.entities,a.totalCount);this._trigger("refreshSuccess",d.asArray(this._clientEntities),this._lastRefreshTotalEntityCount)},_normalizePropertyValue:function(b,a){return d.getProperty(b,a)||""},_onPropertyChanged:function(e,f){c._onPropertyChanged.apply(this,arguments);if(this._refreshAllInProgress)return;if(!this._needRecompute){var d=false;if(this._haveEntity(e)){if(this._filter&&!this._filter(e))d=true}else if(this._filter&&this._filter(e))d=true;if(this._haveEntity(e)&&this._sort)if(b.isFunction(this._sort))d=true;else if(a.isArray(this._sort))d=b.grep(this._sort,function(a){return a.property===f}).length>0;else d=this._sort.property===f;d&&this._setNeedRecompute()}},_createFilterFunction:function(d){var i=this;if(b.isFunction(d))return d;for(var f=this._normalizeFilters(d),c=[],e=0;e<f.length;e++){var a=f[e];if(b.isFunction(a))c.push(a);else{var h=g(a.property,a.operator,a.value);c.push(h)}}return function(b){for(var a=0;a<c.length;a++)if(!c[a](b))return false;return true};function g(d,c,a){var b;switch(c){case"<":b=function(b){return b<a};break;case"<=":b=function(b){return b<=a};break;case"==":b=function(b){return b==a};break;case"!=":b=function(b){return b!=a};break;case">=":b=function(b){return b>=a};break;case">":b=function(b){return b>a};break;case"Contains":b=function(b){if(typeof b==="string"&&typeof a==="string"){b=b.toLowerCase();a=a.toLowerCase()}return b.indexOf(a)>=0};break;default:throw"Unrecognized filter operator.";}return function(c){var a=i._normalizePropertyValue(c,d);return b(a)}}},_getSortFunction:function(){var e=this;if(!this._sort)return null;else if(b.isFunction(this._sort))return this._sort;else if(a.isArray(this._sort)){var c;b.each(this._sort,function(e,b){var a=d(b);if(!c)c=a;else c=function(a,b){return function(c,d){var e=a(c,d);return e===0?b(c,d):e}}(c,a)});return c}else return d(this._sort);function d(a){return function(g,h){var f=!a.descending,d=a.property,b=e._normalizePropertyValue(g,d),c=e._normalizePropertyValue(h,d);return b==c?0:b>c?f?1:-1:f?-1:1}}},_applyQuery:function(f){var g=this,a;if(this._filter)a=b.grep(f,function(a){return g._filter(a)});else a=f;var e=this._getSortFunction(),c;if(e)c=a.sort(e);else c=a;var h=this._skip||0,d=c.slice(h);if(this._take)d=d.slice(0,this._take);return{entities:d,totalCount:c.length}},_onArrayChanged:function(j,g){c._onArrayChanged.apply(this,arguments);if(this._refreshAllInProgress)return;if(!this._needRecompute){var f=this,e=false;switch(j){case"insert":var h=g.items;if(h.length>0){var k=b.grep(h,function(a){return(!f._filter||f._filter(a))&&b.inArray(a,d.asArray(f._clientEntities))<0}).length>0;if(k)e=true}break;case"remove":if(this._take>0||this._skip>0)e=true;else{var l=b.grep(g.items,function(b){return f._haveEntity(b)&&(f.getEntityState(b)||a.EntityState.Deleted)!==a.EntityState.Deleted});if(l.length>0)e=true}break;case"replaceAll":if(!this._refreshAllInProgress){var i=this._applyQuery(g.newItems);if(this.totalCount!==i.totalCount)e=true;else e=!a.sameArrayContents(d.asArray(this._clientEntities),i.entities)}break;default:throw"Unknown array operation '"+j+"'.";}e&&this._setNeedRecompute()}},_handleEntityAdd:function(a){if(!this._needRecompute)this._filter&&!this._filter(a)&&this._setNeedRecompute();c._handleEntityAdd.apply(this,arguments)},_handleEntityDelete:function(){!this._needRecompute&&this._take>0&&this._setNeedRecompute();c._handleEntityDelete.apply(this,arguments)}};a.LocalDataSource=a.deriveClass(c,g,f)})(this,jQuery,upshot);(function(i,c,a,h){function b(b,c){var a="0000"+c;return a.slice(a.length-b)}function e(a){return"datetime'"+b(4,a.getUTCFullYear())+"-"+b(2,a.getUTCMonth()+1)+"-"+b(2,a.getUTCDate())+"T"+b(2,a.getUTCHours())+":"+b(2,a.getUTCMinutes())+":"+b(2,a.getUTCSeconds())+"'"}function f(d){var b=d.results,a=b.length&&b[0].__metadata.type,c;if(a){c={};c[a]={key:["__metadata.uri"]}}var e=d.__count,f=e===h?null:+e;return{type:a,metadata:c,entities:b,totalCount:f}}var d={"get":function(d,i,g,h){var j,b;if(d){j=d.operationName;b=d.operationParameters}if(c.isFunction(b)){g=b;h=i}var k=this,e=[];c.each(c.extend({},b,a.ODataDataProvider.getODataQueryParameters(i)),function(b,a){e.push(b.toString()+"="+a.toString())});var l=e.length?"?"+e.join("&"):"";OData.read(a.DataProvider.normalizeUrl(d.url)+j+l,function(){if(g){arguments[0]=f(arguments[0]);g.apply(k,arguments)}},function(a){h&&h.call(k,-1,a.message,a)})},submit:function(){throw"Saving edits through the OData data provider is not supported.";}},g={getODataQueryParameters:function(b){b=b||{};var d={};if(b.filters&&b.filters.length){var f="",g=function(c,d,b){if(typeof b==="string")if(a.isGuid(b))b="guid'"+b+"'";else b="'"+b+"'";else if(a.isDate(b))b=e(b);switch(d){case"<":return c+" lt "+b;case"<=":return c+" le "+b;case"==":return c+" eq "+b;case"!=":return c+" ne "+b;case">=":return c+" ge "+b;case">":return c+" gt "+b;case"StartsWith":return"startswith("+c+","+b+") eq true";case"EndsWith":return"endswith("+c+","+b+") eq true";case"Contains":return"substringof("+b+","+c+") eq true";default:throw"The operator '"+d+"' is not supported.";}};c.each(b.filters,function(b,a){if(f)f+=" and ";f+=g(a.property,a.operator,a.value)});d.$filter=f}if(b.sort&&b.sort.length){var h=function(a){return!!a.descending?a.property+" desc":a.property};d.$orderby=c.map(b.sort,function(a){return h(a)}).join()}if(b.skip)d.$skip=b.skip;if(b.take)d.$top=b.take;if(b.includeTotalCount)d.$inlinecount="allpages";return d}};a.ODataDataProvider=a.defineClass(null,d,g)})(this,jQuery,upshot);(function(h,a,b){function f(c){var d={};if(c.filters&&c.filters.length){var e="",f=function(d,c,a){if(typeof a==="string")if(b.isGuid(a))a="Guid("+a+")";else a='"'+a+'"';else if(b.isDate(a))a="DateTime("+(a.getTime()*1e4+6.21355968e17)+")";switch(c){case"<":case"<=":case"==":case"!=":case">=":case">":return d+c+a;case"StartsWith":case"EndsWith":case"Contains":return d+"."+c+"("+a+")";default:throw"The operator '"+c+"' is not supported.";}};a.each(c.filters,function(b,a){if(e)e+=" AND ";e+=f(a.property,a.operator,a.value)});d.$where=e}if(c.sort&&c.sort.length){var g=function(a){return!!a.descending?a.property+" desc":a.property};d.$orderby=a.map(c.sort,function(a){return g(a)}).join()}if(c.skip)d.$skip=c.skip;if(c.take)d.$take=c.take;if(c.includeTotalCount)d.$includeTotalCount=c.includeTotalCount;return d}function c(b){b&&a.each(b||{},function(d,c){if(a.isArray(c))b[d]=JSON.stringify(c)});return b}function e(d){var e;a.each(d,function(a){if(/Result$/.test(a)){e=a;return false}});var b=d[e],f={};a.each(b.Metadata,function(b,a){f[a.type]={key:a.key,fields:a.fields,rules:a.rules,messages:a.messages}});var c;if(b.IncludedResults){c={};a.each(b.IncludedResults,function(e,b){var a=b.__type,d=c[a]||(c[a]=[]);d.push(b)})}return{type:b.Metadata[0].type,metadata:f,entities:b.RootResults,includedEntities:c,totalCount:b.TotalCount||0}}var d={"get":function(g,k,h,i){var l,d;if(g){l=g.operationName;d=g.operationParameters}if(a.isFunction(d)){h=d;i=k}var j=this;a.ajax({url:b.DataProvider.normalizeUrl(g.url)+"json/"+l,data:a.extend({},c(d),f(k||{})),success:h&&function(){arguments[0]=e(arguments[0]);h.apply(j,arguments)},error:i&&function(a,c,b){i.call(j,a.status,j._parseErrorText(a.responseText)||b,a)},dataType:"json"})},submit:function(g,h,e,c){var d=this,f=JSON.stringify({changeSet:h});a.ajax({url:b.DataProvider.normalizeUrl(g.url)+"json/SubmitChanges",contentType:"application/json",data:f,dataType:"json",type:"POST",success:(e||c)&&function(k,l,j){var b=k.SubmitChangesResult,i=false;b&&a.each(b,function(c,b){a.each(["ConflictMembers","ValidationErrors","IsDeleteConflict"],function(c,a){if(b.hasOwnProperty(a)){b.Error=b.Error||{};b.Error[a]=b[a];i=true}})});if(!i)e&&e.call(d,b);else if(c){var h="Submit failed.";if(b)for(var f=0;f<b.length;++f){var g=b[f].ValidationErrors&&b[f].ValidationErrors[0]&&b[f].ValidationErrors[0].Message;if(g){h=g;break}}c.call(d,j.status,h,j,b)}},error:c&&function(a,e,b){c.call(d,a.status,d._parseErrorText(a.responseText)||b,a)}})},_parseErrorText:function(a){var b=/Exception]: (.+)\r/g.exec(a);if(b&&b[1])return b[1];if(/^{.*}$/g.test(a)){var c=JSON.parse(a);if(c.ErrorMessage)return c.ErrorMessage}}};b.riaDataProvider=b.defineClass(null,d)})(this,jQuery,upshot);